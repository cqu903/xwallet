<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zerofinance.xwallet.repository.LoanApplicationMapper">

    <resultMap id="LoanApplicationResultMap" type="com.zerofinance.xwallet.model.entity.LoanApplication">
        <id property="id" column="id"/>
        <result property="applicationNo" column="application_no"/>
        <result property="customerId" column="customer_id"/>
        <result property="status" column="status"/>
        <result property="productCode" column="product_code"/>
        <result property="approvedAmount" column="approved_amount"/>
        <result property="fullName" column="full_name"/>
        <result property="hkid" column="hkid"/>
        <result property="homeAddress" column="home_address"/>
        <result property="age" column="age"/>
        <result property="occupation" column="occupation"/>
        <result property="monthlyIncome" column="monthly_income"/>
        <result property="monthlyDebtPayment" column="monthly_debt_payment"/>
        <result property="riskDecision" column="risk_decision"/>
        <result property="riskReferenceId" column="risk_reference_id"/>
        <result property="rejectReason" column="reject_reason"/>
        <result property="cooldownUntil" column="cooldown_until"/>
        <result property="approvedAt" column="approved_at"/>
        <result property="expiresAt" column="expires_at"/>
        <result property="signedAt" column="signed_at"/>
        <result property="disbursedAt" column="disbursed_at"/>
        <result property="idempotencyKey" column="idempotency_key"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <insert id="insert" parameterType="com.zerofinance.xwallet.model.entity.LoanApplication" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO loan_application (
            application_no, customer_id, status, product_code, approved_amount,
            full_name, hkid, home_address, age, occupation,
            monthly_income, monthly_debt_payment,
            risk_decision, risk_reference_id, reject_reason,
            cooldown_until, approved_at, expires_at,
            signed_at, disbursed_at, idempotency_key, created_at
        ) VALUES (
            #{applicationNo}, #{customerId}, #{status}, #{productCode}, #{approvedAmount},
            #{fullName}, #{hkid}, #{homeAddress}, #{age}, #{occupation},
            #{monthlyIncome}, #{monthlyDebtPayment},
            #{riskDecision}, #{riskReferenceId}, #{rejectReason},
            #{cooldownUntil}, #{approvedAt}, #{expiresAt},
            #{signedAt}, #{disbursedAt}, #{idempotencyKey}, #{createdAt}
        )
    </insert>

    <select id="findById" resultMap="LoanApplicationResultMap">
        SELECT id, application_no, customer_id, status, product_code, approved_amount,
               full_name, hkid, home_address, age, occupation,
               monthly_income, monthly_debt_payment,
               risk_decision, risk_reference_id, reject_reason,
               cooldown_until, approved_at, expires_at,
               signed_at, disbursed_at, idempotency_key, created_at, updated_at
        FROM loan_application
        WHERE id = #{id}
        LIMIT 1
    </select>

    <select id="findByIdAndCustomerId" resultMap="LoanApplicationResultMap">
        SELECT id, application_no, customer_id, status, product_code, approved_amount,
               full_name, hkid, home_address, age, occupation,
               monthly_income, monthly_debt_payment,
               risk_decision, risk_reference_id, reject_reason,
               cooldown_until, approved_at, expires_at,
               signed_at, disbursed_at, idempotency_key, created_at, updated_at
        FROM loan_application
        WHERE id = #{id}
          AND customer_id = #{customerId}
        LIMIT 1
    </select>

    <select id="findLatestByCustomerId" resultMap="LoanApplicationResultMap">
        SELECT id, application_no, customer_id, status, product_code, approved_amount,
               full_name, hkid, home_address, age, occupation,
               monthly_income, monthly_debt_payment,
               risk_decision, risk_reference_id, reject_reason,
               cooldown_until, approved_at, expires_at,
               signed_at, disbursed_at, idempotency_key, created_at, updated_at
        FROM loan_application
        WHERE customer_id = #{customerId}
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <select id="findByIdempotencyKey" resultMap="LoanApplicationResultMap">
        SELECT id, application_no, customer_id, status, product_code, approved_amount,
               full_name, hkid, home_address, age, occupation,
               monthly_income, monthly_debt_payment,
               risk_decision, risk_reference_id, reject_reason,
               cooldown_until, approved_at, expires_at,
               signed_at, disbursed_at, idempotency_key, created_at, updated_at
        FROM loan_application
        WHERE customer_id = #{customerId}
          AND idempotency_key = #{idempotencyKey}
        LIMIT 1
    </select>

    <update id="updateStatus">
        UPDATE loan_application
        SET status = #{status},
            signed_at = #{signedAt},
            disbursed_at = #{disbursedAt},
            updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>

</mapper>
